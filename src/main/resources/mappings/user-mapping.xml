<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="UserDAO">

   
<select id="findEmail" resultType="kr.co.mood.user.dao.UserVO">
	select email, id from moodjoin where email = #{email}
</select>
  
<select id="selectAll" parameterType="kr.co.mood.module.ModuleVO" resultType="kr.co.mood.user.dao.UserVO">
   <![CDATA[
      select no, id, AES_DECRYPT(unhex(pwd), 'key') as pwd, name, age, gender, adr, email, phone, day
      from moodjoin where id != 'admin'
      ]]>
      <if test="searchId != null">
      <![CDATA[and id like concat('%', #{searchId}, '%')]]>
      </if>
      <if test="searchName != null">
      <![CDATA[and name like concat('%', #{searchName}, '%')]]>
      </if>
      <if test="startNo != null and endNo != 0">
      order by no desc
      limit #{startNo}, #{endNo}
      
      </if>
   </select>
   
   <select id="selectIdCheck" resultType="kr.co.mood.user.dao.UserVO">
   	select no, id, AES_DECRYPT(unhex(pwd), 'key') as pwd, name, age, gender, adr, email, phone, day
   	from moodjoin 
   	where id = #{id} 
   </select>
   
   	<select id="selectMemberNo" parameterType="kr.co.mood.user.dao.UserVO" resultType="kr.co.mood.user.dao.UserVO">
   <![CDATA[
      select no, id, AES_DECRYPT(unhex(pwd), 'key') as pwd, name, age, gender, adr, email, phone, day
      from moodjoin where no = #{no}
      ]]>
   </select>
   

	 <insert id="insert" parameterType="kr.co.mood.user.dao.UserVO">
      <![CDATA[
      INSERT INTO moodjoin VALUES(no, #{id}, hex(aes_encrypt(#{pwd},'key')), #{name}, #{age} , #{gender}, concat_ws('   ',#{adr} , #{adr2} , #{adr3}), #{email}, #{phone}, now())
      ]]>
   </insert>

   
   <select id="selectId" parameterType="kr.co.mood.user.dao.UserVO" resultType="kr.co.mood.user.dao.UserVO">
   <![CDATA[
      select no, id, AES_DECRYPT(unhex(pwd), 'key') as pwd, name, age, gender, adr, email, phone, day
      from moodjoin where id=#{id} and pwd=hex(aes_encrypt(#{pwd},'key'))
      
      ]]>
   </select>
   
   
   <select id="idChk" parameterType="kr.co.mood.user.dao.UserVO" resultType="int">
		<![CDATA[
		select count(*) from moodjoin where id=#{id} and id != 'admin'
		 ]]>
	</select>
	
	<select id="myinfo_email" parameterType="kr.co.mood.user.dao.UserVO" resultType="int">
		<![CDATA[
		 select count(*) from moodjoin where email = #{email}
		 ]]>
	</select>
	
	 <insert id="insertnaver" parameterType="kr.co.mood.user.dao.UserVO">
      <![CDATA[
      INSERT INTO moodjoin VALUES(no, #{id}, "", #{name}, #{age} , #{gender}, "", #{email}, "", now())
      ]]>
   </insert>
	
   
   <delete id="delete" parameterType="String" >
		<![CDATA[
		delete from moodjoin where id=#{id}
		 ]]>
	</delete>
	
	
    <update id ="update" parameterType="kr.co.mood.user.dao.UserVO">
    <![CDATA[
        update moodjoin
        set adr= concat_ws('   ',#{adr} , #{adr2} , #{adr3}), email=#{email}, phone=#{phone}, pwd=hex(aes_encrypt(#{pwd},'key'))
        where id = #{id}
        ]]>
    </update>
    
     <update id ="password" parameterType="kr.co.mood.user.dao.UserVO">
    <![CDATA[
        update moodjoin
        set adr= concat_ws('   ',#{adr} , #{adr2} , #{adr3}), email=#{email}, phone=#{phone}, pwd=hex(aes_encrypt(#{pwd1},'key'))
        where id = #{id}
        ]]>
    </update>
    
    <update id="updateAdminMember" parameterType="kr.co.mood.user.dao.UserVO">
    	update moodjoin
        set id=#{id}, name=#{name},
        <if test="age != null">
        age = #{age},
        </if>
         adr= concat_ws('   ',#{adr} , #{adr2} , #{adr3}), email=#{email}, phone=#{phone}
         <if test="pwd != null"> 
         , pwd=hex(aes_encrypt(#{pwd},'key'))
         </if>
        where no = #{no}
    </update>
    
    <update id="updatePwd" parameterType="kr.co.mood.user.dao.UserVO">
    	update moodjoin
    	set pwd = hex(aes_encrypt(#{pwd},'key'))
    	where id = #{id}
    </update>
    
    <select id="findKakao" parameterType="kr.co.mood.user.dao.UserVO" resultType="kr.co.mood.user.dao.UserVO">
    <![CDATA[
		select no, id, AES_DECRYPT(unhex(pwd), 'key') as pwd, name, age, gender, adr, email, phone, day
		from moodjoin where name=#{nickname} and age=CONCAT(SUBSTR(#{age_range},1,2), '-', SUBSTR(#{age_range},1,2)+9) and email=#{email} and id=#{email} and gender= CASE WHEN #{gender} = 'male' THEN 'M' ELSE 'F' END
		]]>
	</select>

	
	<insert id="kakaoInsert" parameterType="kr.co.mood.user.dao.UserVO">
	<![CDATA[
		insert into moodjoin(no,id,name,age,email,gender,day) values(no,#{email},#{nickname}, CONCAT(SUBSTR(#{age_range},1,2), '-', SUBSTR(#{age_range},1,2)+9) , #{email},CASE WHEN #{gender} = 'male' THEN 'M' ELSE 'F' END, now())
		 ]]>
	</insert>
    
     <select id="findNaver" parameterType="kr.co.mood.user.dao.UserVO" resultType="kr.co.mood.user.dao.UserVO">
		select no, id, AES_DECRYPT(unhex(pwd), 'key') as pwd, name, age, gender, adr, email, phone, day
		from moodjoin where name=#{name} and email=#{email} and gender=#{gender} and phone=#{phone}
	</select>
    
    <insert id="NaverInsert" parameterType="kr.co.mood.user.dao.UserVO">
	<![CDATA[
		insert into moodjoin(no,id,name,age,email,gender,phone, day) values(no,#{id},#{name}, #{age} , #{email}, #{gender},#{phone}, now())
		 ]]>
	</insert>
    
    <insert id="googleInsert" parameterType="kr.co.mood.user.dao.UserVO">
    	insert into moodjoin(no, id, pwd, name, age, gender, adr, email, phone, day) values(null, #{id}, null, #{name}, null, null, null, #{email}, null, now())
    </insert>
    
    
	</mapper>
