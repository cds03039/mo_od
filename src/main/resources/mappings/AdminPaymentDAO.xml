<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="kr.co.mood.Payment.DAO.AdminPaymentDAO">

    <select id="getCategoryChart1" resultType="kr.co.mood.Payment.VO.AdminChartVO">
         SELECT pro_serialnumber as 'serialNumber', 
         		SUM(pro_paycount) as 'payCount' 
         	FROM product 
         	where pro_paycount > 0 
         	group by pro_serialnumber 
         	order by SUM(pro_paycount) desc
         	limit 0, 5
    </select>
    
    <select id="getCategoryChart2" resultType="kr.co.mood.Payment.VO.AdminChartVO">
         select pro_serialnumber as 'serialNumber', 
         		pro_bucketcount as 'bucketCount' 
         	from product 
         	where pro_bucketcount > 0
         	order by pro_bucketcount desc 
         	limit 0, 5
    </select>
    
    <select id="getCategoryChart3" resultType="kr.co.mood.Payment.VO.AdminChartVO">
         <![CDATA[
          SELECT CASE DAYOFWEEK(approved_at) 
         		WHEN 2 THEN '월요일' 
         		WHEN 3 THEN '화요일' 
         		WHEN 4 THEN '수요일' 
         		WHEN 5 THEN '목요일' 
         		WHEN 6 THEN '금요일' 
         		WHEN 7 THEN '토요일' 
         		WHEN 1 THEN '일요일' 
         		ELSE '유효한 날짜가 아닙니다.' END as week, 
         	sum(amount) as sales 
         	from payment 
         	where Success = 'A'
					and approved_at like concat(#{year}, '%')
         	group by DAYOFWEEK(approved_at)
         	order by DAYOFWEEK(approved_at)
         	]]>
    </select>
    
    <select id="getCategoryChart4" resultType="kr.co.mood.Payment.VO.AdminChartVO">
		<![CDATA[
		select member.gender as gender,
			orderproduct.count as 'productCount',
			product.pro_categoryserial as 'categorySerial',
			member.age as 'age'
		from orderproduct
		inner join moodorder
			on moodorder.orderid = orderproduct.orderid
		inner join moodjoin as member
			on moodorder.userno = member.no
		inner join product
			on product.pro_number = orderproduct.pro_number
		inner join payment
			on payment.orderid = orderproduct.orderid
		where payment.Success = 'A'
			and payment.approved_at like concat(#{year}, '%')
		order by member.age desc 
		limit 0, 5
			]]>
    </select>
    
    <select id="adminPaymentMemberList" resultType="kr.co.mood.Payment.VO.AdminPaymentVO">
    	select moodorder.orderid as 'orderNo', 
			moodorder.address as 'address', 
			member.name as 'name', 
			member.phone as 'phone', 
			moodorder.price as 'amount',
			payment.approved_at as 'payDate'
		from moodorder
		inner join moodjoin as member
			on member.no = moodorder.userNo
		inner join payment
			on payment.orderid = moodorder.orderid
		where payment.Success = 'A'
		group by orderNo
		order by orderNo desc
		<if test="endNo != 0">
		limit #{startNo}, #{endNo}
    	</if>
    	
    </select>    


    <select id="adminPaymentSearchingList"
    	parameterType="kr.co.mood.module.ModuleVO"
     resultType="kr.co.mood.Payment.VO.AdminPaymentVO">
    	select moodorder.orderid as 'orderNo', 
			moodorder.address as 'address', 
			member.name as 'name', 
			member.phone as 'phone', 
			moodorder.price as 'amount',
			payment.approved_at as 'payDate'
		from moodorder
		inner join moodjoin as member
			on member.no = moodorder.userNo
		inner join payment
			on payment.orderid = moodorder.orderid
		where payment.Success = 'A'
		<if test="searchName != null">
		and member.name like concat('%', #{searchName}, '%')
		</if>
		<if test="orderNo > 0">
		and moodorder.orderid = #{orderNo}
		</if>
		<if test="phone != null">
		and member.phone like concat('%', #{phone}, '%')
		</if>
		<if test="date != null">
		and payment.approved_at like concat('%', #{date}, '%')
		</if>
		group by orderNo
		order by orderNo desc
		<if test="endNo > 0">
		limit #{startNo}, #{endNo}
    	</if>    	
    </select>

    
    <select id="adminPaymentList" resultType="kr.co.mood.Payment.VO.AdminPaymentVO">
    	select orderproduct.orderid as'orderNo',
			(orderproduct.price/orderproduct.count) as 'price',
			orderproduct.count as 'productCount',
			product.pro_serialnumber as 'productNo',
			product.pro_name as 'productName'
		from orderproduct
		inner join product
			on product.pro_number = orderproduct.pro_number
		order by orderNo desc
    </select>
    
    
</mapper>


