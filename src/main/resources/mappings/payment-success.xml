<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="KakaoPayApprovalDAO">

	<insert id="insert">
		INSERT INTO payment (payment_method,tid,orderid, userid,
		amount, approved_at)
		SELECT
		#{payment_method_type},
		#{tid},
		op.orderId,
		mo.userNo,
		#{amount.total},
		#{approved_at}
		FROM orderProduct op
		INNER JOIN
		moodorder mo ON mo.orderid = op.orderId
		WHERE op.orderId = (SELECT
		MAX(orderId) FROM orderProduct);
	</insert>

	<delete id="catedelete">
		delete from cate where user_no = #{user_no}
	</delete>
	
	<delete id="cancelDelete">
		delete from orderproduct where orderId = #{orderId} 
	</delete>

	<update id="paycountupdate">
		UPDATE product p
		JOIN cate c ON p.pro_number =
		c.pro_number
		SET p.pro_paycount = p.pro_paycount + c.amount
		WHERE
		FIND_IN_SET(p.pro_number, #{p.pro_number})
	</update>

	<select id="selectlist"
		resultType="kr.co.mood.Payment.VO.KakaoPayApprovalVO">
SELECT o.orderid, p.pro_name, p.pro_img1,
    op.pro_number, p.pro_maindesc, p.pro_maindesctitle, pa.amount, pa.payment_id,
    pa.payment_method, pa.approved_at, op.count, pa.tid, op.pro_option, op.price
FROM moodorder o
JOIN orderproduct op ON op.orderid = o.orderid
JOIN payment pa ON pa.orderid = o.orderid
JOIN product p ON p.pro_number = op.pro_number
WHERE o.userno = #{userno} AND op.orderid IN (
  SELECT DISTINCT op2.orderid 
  FROM orderproduct op2 
  WHERE op2.pro_option = op.pro_option
)
GROUP BY o.orderid, op.pro_option
ORDER BY o.orderid DESC;
	</select>
	
	<select id="selectorderid" resultType="kr.co.mood.Payment.VO.KakaoPayApprovalVO">
SELECT o.orderid, pa.approved_at,pa.payment_id,
op.price, SUM(op.count) as total_count
FROM moodorder o
JOIN orderproduct op ON op.orderid = o.orderid
JOIN payment pa ON pa.orderid = o.orderid
WHERE o.userno = #{userno}
GROUP BY o.orderid, pa.approved_at, pa.amount
ORDER BY o.orderid DESC;
	</select>
	

</mapper>