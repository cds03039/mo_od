<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="KakaoPayApprovalDAO">

	<insert id="insert">
		INSERT INTO payment (payment_method,tid,orderid,userid,amount)
		SELECT
		#{payment_method_type},
		#{tid},
		op.orderId,
		mo.userNo,
		#{amount.total}
		FROM orderProduct op
		INNER JOIN
		moodorder mo ON mo.orderid = op.orderId
		WHERE op.orderId = (SELECT
		MAX(orderId) FROM orderProduct)
	</insert>
	

	

	<delete id="catedelete">
		delete from cate where user_no = #{user_no}
	</delete>
	
	<delete id="cancelDelete">
		delete from orderProduct where orderId = #{orderId}
	</delete>
	<update id="successUpdate">
		update payment set Success = '결제 취소',
		CancelTime = now() where orderid = #{orderId};
	</update>

	<update id="paycountupdate">
		UPDATE product p
		JOIN cate c ON p.pro_number =
		c.pro_number
		SET p.pro_paycount = p.pro_paycount + c.amount
		WHERE
		FIND_IN_SET(p.pro_number, #{p.pro_number})
	</update>

	<select id="selectlist"
		resultType="kr.co.mood.Payment.VO.KakaoPayApprovalVO">
SELECT o.orderid, p.pro_name, p.pro_img1,
    op.pro_number, p.pro_maindesc, p.pro_maindesctitle, pa.amount, pa.payment_id,
    pa.payment_method, pa.SuccessTime, op.count, pa.tid, op.pro_option, op.price,pa.Success
FROM moodorder o
JOIN orderProduct op ON op.orderid = o.orderid
JOIN payment pa ON pa.orderid = o.orderid
JOIN product p ON p.pro_number = op.pro_number
WHERE o.userno = #{userno} AND op.orderid IN (
  SELECT DISTINCT op2.orderid 
  FROM orderProduct op2 
  WHERE op2.pro_option = op.pro_option
)
GROUP BY o.orderid, op.pro_option
ORDER BY o.orderid DESC;
	</select>
	
	<select id="selectorderid" resultType="kr.co.mood.Payment.VO.KakaoPayApprovalVO">
SELECT o.orderid, pa.SuccessTime,pa.payment_id,pa.Success,
op.price, SUM(op.count) as total_count,o.price as total
FROM moodorder o
JOIN orderProduct op ON op.orderid = o.orderid
JOIN payment pa ON pa.orderid = o.orderid
WHERE o.userno = #{userno}
GROUP BY o.orderid, pa.SuccessTime, pa.amount
ORDER BY o.orderid DESC;
	</select>
	
<select id="pageselectorderid" resultType="kr.co.mood.Payment.VO.KakaoPayApprovalVO" parameterType="kr.co.mood.module.ModuleVO">
SELECT o.orderid, pa.SuccessTime,pa.payment_id,pa.Success,
op.price, SUM(op.count) as total_count,o.price as total
FROM moodorder o
JOIN orderProduct op ON op.orderid = o.orderid
JOIN payment pa ON pa.orderid = o.orderid
WHERE o.userno = #{orderNo}
GROUP BY o.orderid, pa.SuccessTime, pa.amount
ORDER BY o.orderid DESC 
<if test="endNo != 0">
LIMIT #{startNo}, #{endNo}
</if>
</select>

<select id="totalRecords" resultType="int">
SELECT COUNT(*) AS count
FROM (
  SELECT o.orderid, pa.SuccessTime,pa.payment_id,pa.Success,
         op.price, SUM(op.count) as total_count,o.price as total
  FROM moodorder o
  JOIN orderProduct op ON op.orderid = o.orderid
  JOIN payment pa ON pa.orderid = o.orderid
  WHERE o.userno = #{userno}
  GROUP BY o.orderid, pa.SuccessTime, pa.amount
  ORDER BY o.orderid DESC
) AS subquery;
</select>
	
		<select id="selectsuccesslist"
		resultType="kr.co.mood.Payment.VO.KakaoPayApprovalVO">
SELECT o.orderid, p.pro_name, p.pro_img1,
    op.pro_number, p.pro_maindesc, p.pro_maindesctitle, pa.amount, pa.payment_id,pa.Success,
    pa.payment_method, pa.SuccessTime, op.count, pa.tid, op.pro_option, o.price, pa.orderid, (
        SELECT COUNT(*) 
        FROM payment 
        WHERE orderid = #{orderid}
    ) AS row_count
FROM moodorder o
JOIN orderProduct op ON op.orderid = o.orderid
JOIN payment pa ON pa.orderid = o.orderid
JOIN product p ON p.pro_number = op.pro_number
WHERE pa.orderid = #{orderid} AND op.orderid IN (
  SELECT DISTINCT op2.orderid 
  FROM orderProduct op2 
  WHERE op2.pro_option = op.pro_option
)
GROUP BY o.orderid, op.pro_option
ORDER BY o.orderid DESC;
	</select>
	

</mapper>