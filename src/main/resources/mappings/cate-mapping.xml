<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CateDAO">


   <insert id="insert">
      insert into cate(pro_number, user_no,cate_pro_price,total,pro_option)
      values(#{pro_number},#{user_no},#{cate_pro_price},#{total},#{pro_option}) ON DUPLICATE KEY UPDATE amount = amount+1, total = total + cate_pro_price
   </insert>



   <select id="selectlist" resultType="kr.co.mood.cate.vo.CateVO">


      select cate_id, p.pro_number,
      c.user_no,pro_name ,pro_price,pro_img1,pro_maindesctitle,amount,total,pro_option,cate_pro_price,total
      from moodjoin m, cate c, product p
      where m.no=c.user_no and c.pro_number = p.pro_number and
      c.user_no=#{userid} order by cate_id
   </select>
	
	<select id="selectAll" parameterType="kr.co.mood.module.ModuleVO" resultType="kr.co.mood.cate.vo.CateVO">
	  select cate_id, p.pro_number,
      c.user_no,pro_name ,pro_price,pro_img1,pro_maindesctitle,amount,total,pro_option,cate_pro_price,total,name,pro_serialnumber
      from moodjoin m, cate c, product p
      where m.no=c.user_no and c.pro_number = p.pro_number
      <if test="searchId != null">
      <![CDATA[and name like concat('%', #{searchId}, '%')]]>
      </if>
      <if test="searchName != null">
      <![CDATA[and pro_name like concat('%', #{searchName}, '%')]]>
      </if>
      <if test="startNo != null and endNo != 0">
      limit #{startNo} , #{endNo}
      </if>
	</select>

   <update id="plusupdate">
      update cate set
        total = total + cate_pro_price,
        amount = amount + 1
    where cate_id = #{cate_id}
   </update>
   
<update id="minusupdate">
  update cate set
    amount = case
      when amount > 1 then amount - 1
      else 1
    end,
    total = case
      when total > cate_pro_price then total - cate_pro_price
      else total
    end
  where cate_id = #{cate_id}
</update>
   

   
   <update id="dupcate">
      select * from cate where user_no = #{user_no} and pro_number = #{pro_number}
   </update>
   
   <delete id="catedelete">
      delete from cate where cate_id = #{cate_id}
   </delete>
   
   
</mapper>